"""
Health Report Formatter
Formats health scan results as plain text for export
"""

from health_checks.base import Severity
from services.health_checker import get_health_checker


def format_health_report(health_report) -> str:
    """
    Format health report as plain text for export.

    Args:
        health_report: HealthReport object from services/health_checker.py

    Returns:
        Formatted report text with headers, sections, and issue details

    Example output:
        ==================================================================
        CLAUDE CODE HEALTH REPORT
        ==================================================================

        Project: /path/to/project
        Health Score: 85/100 (Healthy)
        Detectors Run: 22
        Issues Found: 3
        ...
    """
    if not health_report:
        return ""

    checker = get_health_checker()
    score_label = checker.get_score_label(health_report.score)

    lines = []
    lines.append("=" * 70)
    lines.append("CLAUDE CODE HEALTH REPORT")
    lines.append("=" * 70)
    lines.append(f"\nProject: {health_report.project_path}")
    lines.append(f"Health Score: {health_report.score}/100 ({score_label})")
    lines.append(f"Detectors Run: {health_report.detectors_run}")
    lines.append(f"Issues Found: {len(health_report.issues)}")
    lines.append("")

    if not health_report.issues:
        lines.append("âœ… No issues found! Your Claude Code project looks healthy.")
    else:
        # Group issues by severity
        critical_issues = [i for i in health_report.issues if i.severity == Severity.CRITICAL]
        warning_issues = [i for i in health_report.issues if i.severity == Severity.WARNING]
        info_issues = [i for i in health_report.issues if i.severity == Severity.INFO]

        for issues, severity_name, emoji in [
            (critical_issues, "CRITICAL", "ðŸ”´"),
            (warning_issues, "WARNING", "ðŸŸ¡"),
            (info_issues, "INFO", "ðŸ”µ"),
        ]:
            if issues:
                lines.append(f"\n{emoji} {severity_name} ISSUES ({len(issues)})")
                lines.append("-" * 70)
                for issue in issues:
                    lines.append(f"\n[{issue.rule_id}] {issue.title}")
                    lines.append(f"Message: {issue.message}")
                    lines.append(f"Suggestion: {issue.suggestion}")
                    if issue.file_path:
                        lines.append(f"File: {issue.file_path}")
                    if issue.topic_slug:
                        lines.append(f"Learn more: {issue.topic_slug}")
                    lines.append("")

    lines.append("=" * 70)
    lines.append(f"Generated by Claude Code Coach (C3)")
    lines.append("=" * 70)

    return "\n".join(lines)
